name: Malware Detection Test

# MANUAL ONLY - Tests that the scanner correctly detects malware
on:
  workflow_dispatch:
    inputs:
      malware-samples:
        description: 'Sample types to inject'
        type: choice
        options:
          - all
          - obfuscated-js
          - elf-malware
          - pe-malware
        default: all
      malware-ecosystem:
        description: 'Ecosystem for malware injection'
        type: choice
        options:
          - npm
          - pip
          - maven
          - cargo
          - go
          - ruby
          - nuget
          - generic
        default: npm

jobs:
  malware-test:
    name: Test Malware Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install
      
      # Inject malware samples
      - name: Inject malware test samples
        uses: Unknown-Cyber-Inc/npm-package-scanner/malware-test-inject@main
        id: inject
        with:
          api-key: ${{ secrets.UC_API_KEY }}
          ecosystem: ${{ inputs.malware-ecosystem }}
          package-name: test-malware-package
          package-version: 1.0.0-infected
          samples: ${{ inputs.malware-samples }}
      
      - name: Verify injection
        run: |
          echo "Injected ${{ steps.inject.outputs.samples-count }} samples"
          echo "Path: ${{ steps.inject.outputs.injected-path }}"
          ls -la "${{ steps.inject.outputs.injected-path }}/" || true
      
      # Scan with YARA
      - name: Scan for malware
        uses: Unknown-Cyber-Inc/npm-package-scanner@main
        id: scan
        with:
          upload: 'true'
          deep-scan: 'true'
          yara-scan: 'true'
          yara-include: '*.js,*.exe,*.elf'
          generate-summary: 'true'
          fail-on-threats: 'false'  # Don't fail - we want to verify detection
          api-key: ${{ secrets.UC_API_KEY }}
      
      # Verify detection
      - name: Verify malware was detected
        run: |
          echo "=== Malware Detection Results ==="
          echo "YARA matches: ${{ steps.scan.outputs.yara-matches }}"
          echo "YARA high severity: ${{ steps.scan.outputs.yara-high-severity }}"
          echo "Threats found: ${{ steps.scan.outputs.threats-found }}"
          
          if [ "${{ steps.scan.outputs.yara-matches }}" -eq "0" ]; then
            echo "::error::YARA did not detect the injected malware - FAILED"
            exit 1
          fi
          
          echo ""
          echo "âœ… SUCCESS: Malware was correctly detected!"
          echo "The scanner is working properly."
