name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install
      
      - name: Download malware samples for testing
        if: hashFiles('package.json') && contains(github.event.head_commit.message, 'infected')
        env:
          UC_API_KEY: ${{ secrets.UC_API_KEY }}
        run: |
          # Create infected package directory
          mkdir -p node_modules/lodash_infected
          
          # Create package.json for the fake package
          echo '{"name":"lodash_infected","version":"4.17.21-infected","description":"Simulated compromised package for demo"}' > node_modules/lodash_infected/package.json
          
          # Download bun_environment.js (Shai Hulud obfuscated JS)
          # Note: UC API returns raw file content, not a zip when called programmatically
          HTTP_CODE=$(curl -s -w "%{http_code}" -o node_modules/lodash_infected/bun_environment.js "https://api.unknowncyber.com/v2/files/cbb9bc5a8496243e02f3cc080efbe3e4a1430ba0671f2e43a202bf45b05479cd/download/?key=$UC_API_KEY")
          echo "Download bun_environment.js: HTTP $HTTP_CODE, size $(stat -c%s node_modules/lodash_infected/bun_environment.js 2>/dev/null || echo 0) bytes"
          
          # Download neotyxa.exe (actual malware binary - ELF format)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o node_modules/lodash_infected/neotyxa.exe "https://api.unknowncyber.com/v2/files/7f20b9e8235746e29e853a4793f64b2a02cf6a4eeca56fd3bd1e110bb4a84b0e/download/?key=$UC_API_KEY")
          echo "Download neotyxa.exe: HTTP $HTTP_CODE, size $(stat -c%s node_modules/lodash_infected/neotyxa.exe 2>/dev/null || echo 0) bytes"
          
          # Verify downloads
          echo "=== lodash_infected contents ==="
          ls -la node_modules/lodash_infected/
          echo ""
          echo "=== File types ==="
          file node_modules/lodash_infected/* || true
      
      - name: Scan npm packages
        uses: Unknown-Cyber-Inc/npm-package-scanner@main
        id: scan
        with:
          upload: 'true'
          deep-scan: 'true'
          include-all-files: 'true'
          yara-scan: 'true'
          yara-include: '*.js,*.exe'
          generate-summary: 'true'
          fail-on-threats: 'true'
          api-key: ${{ secrets.UC_API_KEY }}
