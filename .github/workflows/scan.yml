name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      inject-malware:
        description: 'Inject malware samples for testing'
        type: boolean
        default: false
      malware-samples:
        description: 'Sample types to inject (obfuscated-js,elf-malware,pe-malware,all)'
        type: string
        default: 'all'
      malware-ecosystem:
        description: 'Ecosystem for malware injection'
        type: choice
        options:
          - npm
          - pip
          - maven
          - cargo
          - go
          - ruby
          - nuget
          - generic
        default: npm

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install
      
      # Inject malware samples for testing
      # Triggered by: workflow_dispatch checkbox OR commit message containing 'infected'
      - name: Inject malware test samples
        uses: Unknown-Cyber-Inc/npm-package-scanner/malware-test-inject@main
        if: ${{ inputs.inject-malware || contains(github.event.head_commit.message, 'infected') }}
        with:
          api-key: ${{ secrets.UC_API_KEY }}
          ecosystem: ${{ inputs.malware-ecosystem || 'npm' }}
          package-name: lodash_infected
          package-version: 4.17.21-infected
          samples: ${{ inputs.malware-samples || 'all' }}
      
      - name: Scan packages
        uses: Unknown-Cyber-Inc/npm-package-scanner@main
        id: scan
        with:
          upload: 'true'
          deep-scan: 'true'
          include-all-files: 'true'
          yara-scan: 'true'
          yara-include: '*.js,*.exe,*.elf'
          generate-summary: 'true'
          fail-on-threats: 'true'
          license-check: 'true'
          api-key: ${{ secrets.UC_API_KEY }}
